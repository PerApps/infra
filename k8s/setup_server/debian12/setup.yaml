---
- name: SetupServer
  hosts: k8s_master, k8s_worker
  become: yes

  tasks:
    - name: Update the apt package index
      apt:
        update_cache: yes

    - name: Install packages to allow apt to use a repository over HTTPS
      apt:
        name:
          - apt-transport-https
          - ca-certificates
          - curl
          - gnupg
          - lsb-release
        state: present

    - name: Add Docker's official GPG key
      apt_key:
        url: https://download.docker.com/linux/debian/gpg
        state: present

    - name: Add Docker's official APT repository
      apt_repository:
        repo: "deb [arch=amd64] https://download.docker.com/linux/debian {{ ansible_distribution_release }} stable"
        state: present

    - name: Update the apt package index again
      apt:
        update_cache: yes

    - name: Install Docker
      apt:
        name:
          - docker-ce=5:27.3.1-1~debian.12~bookworm
          - docker-ce-cli=5:27.3.1-1~debian.12~bookworm
          - containerd.io=1.7.23-1
        state: present

    - name: Start and enable Docker service
      systemd:
        name: docker
        enabled: yes
        state: started

    - name: Add user to docker group
      user:
        name: "{{ ansible_user }}"
        groups: docker
        append: yes

    - name: Download cri-docker release
      get_url:
        url: https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.9/cri-dockerd_0.3.9.3-0.debian-bullseye_amd64.deb
        dest: /tmp/cri-dockerd.deb

    - name: Install cri-docker
      apt:
        deb: /tmp/cri-dockerd.deb
        state: present

    - name: Start and enable cri-docker service
      systemd:
        name: cri-docker.socket
        enabled: yes
        state: started

    - name: Reload service docker
      ansible.builtin.service:
        name: docker
        state: reloaded

    - name: Add Kubernetes signing key
      apt_key:
        url: https://pkgs.k8s.io/core:/stable:/v1.31/deb/Release.key
        state: present

    - name: Add Kubernetes APT repository
      apt_repository:
        repo: "deb https://pkgs.k8s.io/core:/stable:/v1.31/deb/ /"
        state: present

    - name: Update the apt package index again
      apt:
        update_cache: yes

    - name: Install Kubernetes packages
      apt:
        name:
          - kubelet=1.31.3-1.1
          - kubeadm=1.31.3-1.1
          - kubectl=1.31.3-1.1
        state: present

    - name: Enable and start kubelet service
      systemd:
        name: kubelet
        enabled: yes
        state: started