---
- name: SetupServer
  hosts: k8s_master, k8s_worker
  become: yes
  
  tasks:
  - name: Add docker repository
    get_url:
      url: https://download.docker.com/linux/centos/docker-ce.repo
      dest: /etc/yum.repos.d/docker-ce.repo
  
  - name: Install docker
    ansible.builtin.dnf:
      name:
        - docker-ce
        - docker-ce-cli
        - containerd.io
        - docker-buildx-plugin
      state: present

  - name: Start service docker
    ansible.builtin.service:
      name: docker
      state: started
    
  - name: Enable service docker
    ansible.builtin.service:
      name: docker
      enabled: yes
      
  - name: Install cri-docker
    ansible.builtin.dnf:
      name: 'https://github.com/Mirantis/cri-dockerd/releases/download/v0.3.9/cri-dockerd-0.3.9-3.el8.x86_64.rpm'
      state: present
      disable_gpg_check: true
      
  - name: Start service cri-docker.socket
    ansible.builtin.service:
      name: cri-docker.socket
      state: started
      
  - name: Enable service cri-docker.socket
    ansible.builtin.service:
      name: cri-docker.socket
      enabled: yes

  - name: Reload service docker
    ansible.builtin.service:
      name: docker
      state: reloaded
  
  - name: Set setenforce
    ansible.builtin.shell: setenforce 0 && sed -i 's/^SELINUX=enforcing$/SELINUX=permissive/' /etc/selinux/config

  - name: Add k8s repository
    ansible.builtin.shell: |
      cat <<EOF | sudo tee /etc/yum.repos.d/kubernetes.repo
      [kubernetes]
      name=Kubernetes
      baseurl=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/
      enabled=1
      gpgcheck=1
      gpgkey=https://pkgs.k8s.io/core:/stable:/v1.29/rpm/repodata/repomd.xml.key
      exclude=kubelet kubeadm kubectl cri-tools kubernetes-cni
      EOF
    
  - name: Install k8s
    ansible.builtin.dnf:
      name:
        - kubelet
        - kubeadm
        - kubectl
      state: present
      disable_excludes: kubernetes

  - name: Start service kubelet
    ansible.builtin.service:
      name: kubelet
      state: started
    
  - name: Enable service kubelet
    ansible.builtin.service:
      name: kubelet
      enabled: yes
      
- name: SetupFirewall
  hosts: k8s_master, k8s_worker
  become: yes
  
  tasks:
  - name: Stop service firewalld
    ansible.builtin.service:
      name: firewalld
      state: stopped
    
  - name: Disable service firewalld
    ansible.builtin.service:
      name: firewalld
      enabled: no